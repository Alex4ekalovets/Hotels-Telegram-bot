![](images/Logo.png)

## Содержание
<!-- TOC -->
  * [Основные функции](#основные-функции)
  * [Установка и настройка](#установка-и-настройка)
  * [Используемые технологии](#используемые-технологии)
  * [Работа телеграм-бота](#работа-телеграм-бота)
    * [Начало работы](#начало-работы)
    * [Поиск отелей](#поиск-отелей)
    * [История запросов](#история-запросов)
    * [Игра "Города"](#игра--города-)
    * [Пример работы телеграм-бота](#пример-работы-телеграм-бота)
  * [Базы данных](#базы-данных)
<!-- TOC -->

## Основные функции

* Поиск отелей в заданном городе на указанные даты с сайта [Hotels.com](https://www.hotels.com/)
  * самых дешевых
  * самых дорогих
  * лучших по критериям - стоимость за ночь и расстояние от центра
* Отображение информации по результатам поиска
  * Фотографии отеля
  * Название со ссылкой на сайт [Hotels.com](https://www.hotels.com/)
  * Адрес
  * Расстояние до центра (миль)
  * Стоимость за ночь (USD)
  * Количество ночей
  * Общая стоимость (USD с учетом налогов)
  * Оценка отеля на сайте [Hotels.com](https://www.hotels.com/)
* Выбор параметров вывода результатов
  * максимальное количество результатов поиска
  * количество фотографий
* Сохранение истории поиска
  * Просмотр последних 10 запросов пользователя
  * Возможность повтора запроса
* Игра "Города" с ботом:
  * Задание и изменение игрового имени
  * Сохранение лучшего результата игрока
  * Вывод ТОП10 игроков и места текущего игрока
  * Город бота имеет ссылку на google maps

**_! Поиск по городам России на сайте [Hotels.com](https://www.hotels.com/) не предусмотрен_**

## Установка и настройка

1. Скопируйте файлы проекта
```commandline
git clone https://gitlab.skillbox.ru/alexander_chekalovets/python_basic_diploma
```
Эта команда создаст папку `python_basic_diploma`  и сохранит в ней все требуемые файлы.

2. Настройте виртуальное окружение (инструкция для MacOS)

* Перейти в папку с телеграм-ботом
```commandline
cd /path/to/python_basic_diploma
```
* Создать виртуальное окружение
```commandline
python3 -m venv env
```
* Активировать виртуальное окружение
```commandline
source env/bin/activate
```
3. Установите зависимости в виртуальное окружение:
```commandline
pip install -r requirements.txt
```
4. Переименуйте файл `env.template` в `.env`

Заполните в файле `.env` ваш (администратора) Telegram id и придумайте пароль. 
Данная информация потребуется для очистки баз данных
```dotenv
ADMIN_ID = "98723498235"
ADMIN_PASSWORD = "12345678"
```


5. Зарегистрируйте вашего телеграм-бота
* Для регистрации нового бота запустите в Telegram бота [BotFather](https://t.me/botfather) и отправьте команду:
```commandline
/newbot
```
* Введите название бота, которое будет отображаться у пользователя
* Введите имя бота, оканчивающееся на "bot" (например "EasyTravelBot").
Если имя уже занято, Вам будет предложено ввести новое
* Из сообщения об успешном создании бота скопируйте токен в файл `.env`. В результате должна получиться строка вида:
```dotenv
BOT_TOKEN='1234567890:GHND5d897ndsHDE89nasds644sasd8sah7as3'
```
* Дополнительно можно настроить бота, с помощью команды в чате с ботом [BotFather](https://t.me/botfather)
```commandline
/mybots
```
Подробную информацию о настройках и возможностях телеграм-ботов можно получить [здесь](https://core.telegram.org/bots#6-botfather) 

6. Получите доступ к API сайта Hotels.com
* Пройдите регистрацию на сайте [RapidAPI](https://rapidapi.com/auth/sign-up?referral=/apidojo/api/hotels4/)
* Оформите подписку по ссылке [API Hotels](https://rapidapi.com/apidojo/api/hotels4/pricing)
* На странице [API Hotels](https://rapidapi.com/apidojo/api/hotels4/)
скопируйте ключ доступа к API из поля X-RapidAPI-Key в файл `.env`. 
В результате должна получиться строка вида: 
```dotenv
RAPID_API_KEY = "09234kjhds90123jsdkj394rkjsdf87234kjdhf398fdkjhf398"
```

7. Запустите бота командой
```commandline
python main.py
```

## Используемые технологии
* Python 3.9
* pyTelegramBotAPI 4.8.0
* python-dotenv 0.19.2
* requests 2.28.1
* python-telegram-bot-calendar 1.0.5
* python-telegram-bot 13.15
* loguru 0.6.0
* translators 5.5.5
* peewee 3.15.4

## Работа телеграм-бота
### Начало работы
Для начала работы отправьте боту команду `/start`

### Поиск отелей
Для поиска отелей выберите один из предложенных вариантов поиска
в меню или с помощью команд:
* `/lowprice` - вывод самых дешевых отелей
* `/highprice` - вывод самых дорогих отелей
* `/bestdeal` - вывод отелей, наиболее подходящих по цене и расположению от центра

Далее вводите информацию по запросам бота
### История запросов
При вводе команды `/history` бот покажет последние 10 запросов. 
Для каждого запроса можно показать результаты или повторить запрос.

### Игра "Города"
При вводе команды `/game` бот предлагает сыграть в игру "Города".

Правила простые - необходимо называть города на последнюю букву города соперника 
(если последняя буква "Ъ" или "Ь", то берется предпоследняя)
* При первом запуске необходимо ввести игровое имя, его можно сменить в игровом меню
* Далее выводится игровое меню:
  * Начать игру
  * Показать ТОП10 (так же отображается Ваше место, даже ели вы не в ТОП 10)
  * Сменить игровое имя
* Если был введен несуществующий город, город не на ту букву или город,
который уже был, выводится соответствующее сообщение. Необходимо повторить ввод
* Бот проверяет введенный Вами город, а так же выбирает свой город из локальной базы данных. 
База данных может охватывать не все известные города, с этим придется смириться:)
БД хранит 6717 проверенных городов на русском языке, Вам будет интересно посоревноваться с ботом
* Если все города на одну из букв сыграны, бот сдаётся и Вам будет начислено 500 дополнительных очков. 
Но это будет непросто. Бот знает несколько городов на "Ы" и "Й", а Вы?
* Если у Вас закончились варианты, то можно сдаться, нажав соответствующую кнопку
* Любой город, названный ботом, имеет ссылку на google maps
* Сохраняется только максимальное количество набранных Вами очков
* Из уважения к жителям городов, названия городов необходимо вводить с большой буквы,
иначе бот выдаст сообщение, что такого города не существует


### Пример работы телеграм-бота  
[![Watch the video](https://img.youtube.com/vi/0JA0FkMZprU/maxresdefault.jpg)](https://www.youtube.com/watch?v=0JA0FkMZprU)

## Базы данных
Для хранения истории запросов и игровой статистики пользователей используется база данных SQLite

Взаимодействие с SQLite выполнено с помощью ORM [Peewee](https://docs.peewee-orm.com/en/latest/)

Для отчистки базы данных истории запросов и(или) статистики игры "Города" введите команду в телеграм боте `/clear`.
Далее действуйте согласно запросам бота

При этом таблица "cities" в БД игры `database/game_cities/game.db` не очищается, так как она нужна для работы игры

Структура БД истории запросов приведена ниже

![History.png](images%2FHistory.png)


Структура БД игровой статистики приведена ниже

![Game.png](images%2FGame.png)